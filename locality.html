<html>
    <head>
        <title>Choose Locality</title>
    </head>
    <body>
        <h1>Choose Locality</h1>

        <ol id="MdmsValueList" >

        </ol>

        <script>

                var mdmsPath = "/egov-mdms-service/v1/_search";
    
                let moduleName = "egov-location";
                let masterName = "TenantBoundary";
                let filterPath = "$.[1].boundary.children.*.children.*.children.*.name";
            
                var whatsappURL = "https://api.whatsapp.com/send";
 
                window.onload = getMdmsData();
    
                function getTenantId() {
                    var urlParams = new URLSearchParams(location.search);
                    return urlParams.get("tenantId");
                }

                function getMobileNumberFormURLParams() {
                    var urlParams = new URLSearchParams(location.search);
                    return urlParams.get("mobile");
                }
    
                function getMdmsData() {
                    var requestBody = {
                        "RequestInfo" : {},
                        "MdmsCriteria" : {
                            "tenantId" : getTenantId(),
                            "moduleDetails" : [
                                {
                                    "moduleName" : moduleName,
                                    "masterDetails" : [
                                        {
                                            "name" : masterName,
                                            "filter" : filterPath
                                        }
                                    ]
                                }
                            ]
                        }
                    };
    
                    var headers = {
                        "Content-Type" : "application/json"
                    };
    
                    var request = {
                        method : "POST",
                        headers : headers,
                        body : JSON.stringify(requestBody)
                    }
    
                    fetch(mdmsPath, request)
                    .then(response => {
                        if(response.status === 200)
                            return response.json()
                        else
                            throw new Error("Error fetching Mdms Data");
                    })
                    .then( responseJSON => displayMdmsValueList(responseJSON));    
                }
    
                function displayMdmsValueList(mdmsData) {
                    var mdmsValues = getMdmsValueList(mdmsData);
    
                    var mdmsValuesOrderedList = document.getElementById("MdmsValueList");
    
                    for(var i in mdmsValues) {
                        var value = mdmsValues[i]
                        var listItem = document.createElement("li");
                        listItem.appendChild(createAnchorNode(value));
                        mdmsValuesOrderedList.appendChild(listItem);
                    }
    
                }
    
                function getMdmsValueList(mdmsData) {
                    var mdmsValues = [];
                    var mdmsValueData = mdmsData["MdmsRes"][moduleName][masterName];
                    for(var i in mdmsValueData) {
                        mdmsValues.push( mdmsValueData[i] );
                    }
                    return mdmsValues;
                }

                function createWhatsAppLink(value) {
                    let mobile = getMobileNumberFormURLParams();
                    var url = whatsappURL;
                    url += '?phone=' + mobile;
                    url += '&text=' + value;
                    return url;
                }

                function createAnchorNode(value) {
                    var anchorNode = document.createElement('a');
                    anchorNode.setAttribute('href', createWhatsAppLink(value));
                    anchorNode.textContent = value;
                    return anchorNode;
                }

            </script>
    </body>
</html>
